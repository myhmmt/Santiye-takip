<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Şantiye Takip – Ekip Önce / Görsel Durum + Düzeltme</title>
<style>
  :root{--bg:#0b1220;--card:#111827;--line:#1f2937;--muted:#94a3b8}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:#e5e7eb}
  header{position:sticky;top:0;background:#0b1220cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:10px 14px;font-weight:800}
  .wrap{max-width:1000px;margin:12px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0b1220;color:#e5e7eb}
  textarea{min-height:80px;width:100%}
  button{background:linear-gradient(90deg,#0ea5e9,#22d3ee);color:#001016;border:none;font-weight:700;cursor:pointer}
  .ghost{background:#0b1220;border:1px solid #243244;color:#e5e7eb}
  .danger{background:#7f1d1d;color:#fff;border:none}
  .muted{color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .note{border-left:3px solid #0ea5e9;padding-left:10px}

  /* Blok ızgarası */
  .grid{display:grid;gap:8px}
  .row1{grid-template-columns:repeat(12,1fr)}  /* AC … AN */
  .row2{grid-template-columns:repeat(13,1fr)}  /* AB … I  */
  .row3{grid-template-columns:repeat(12,1fr)}  /* AA,Z,U,T,A … H */
  .tile{padding:10px 6px;text-align:center;border:1px solid #243244;border-radius:10px;background:#0b1220;cursor:pointer;font-weight:800}
  .badge{font-size:10px;color:#cbd5e1;display:block;margin-top:4px;font-weight:500}

  /* Daire tipi arka plan tonları */
  .t-41{background:#7c2d4e}
  .t-51{background:#8a6a15}
  .t-62{background:#0f3b46}
  .t-72{background:#153056}
  .own{border-color:#22d3ee}
  .patron{outline:2px dashed #22d3ee}

  /* Ekip durum çerçevesi */
  .st-none{box-shadow:0 0 0 3px #374151 inset}       /* gri: başlanmadı */
  .st-progress{box-shadow:0 0 0 3px #f59e0b inset}   /* sarı: devam/başladı */
  .st-done{box-shadow:0 0 0 3px #10b981 inset}       /* yeşil: bitti */

  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-right:6px}

  /* ufak etiket */
  .chip{padding:2px 6px;border-radius:999px;border:1px solid #334155;background:#0b1220;color:#cbd5e1;font-size:12px}
</style>
</head>
<body>
<header>🏗️ Şantiye Takip – Ekip Önce / Görsel Durum + Düzeltme</header>

<div class="wrap">

  <!-- 1) EKİP SEÇ + ÖZET/FİLTRE -->
  <section class="card">
    <h3>1) Ekip Seç</h3>
    <div class="row">
      <select id="crewPick" style="min-width:200px">
        <option value="">Ekip seç</option>
        <option>Elektrik</option><option>Mekanik</option>
        <option>Çatı (kereste)</option><option>Çatı (kiremit)</option><option>Çatı (oluk)</option>
        <option>Denizlik</option><option>Parke</option><option>Seramik</option><option>Boya</option>
        <option>Tg5</option><option>PVC</option><option>Kör Kasa</option><option>Şap</option>
        <option>Dış Cephe</option><option>Makina Alçı</option><option>Saten Alçı</option><option>Kaba Sıva (iç)</option>
      </select>

      <span class="muted">Durum:
        <span class="dot" style="background:#10b981"></span>tamamlandı •
        <span class="dot" style="background:#f59e0b"></span>devam ediyor •
        <span class="dot" style="background:#374151"></span>başlanmadı
      </span>

      <select id="statusFilter">
        <option value="">Tümü</option>
        <option value="done">Sadece tamamlanan</option>
        <option value="progress">Sadece devam eden</option>
        <option value="none">Sadece başlanmayan</option>
      </select>

      <button id="clearFilter" class="ghost">Filtreyi sıfırla</button>
    </div>
  </section>

  <!-- 2) BLOK IZGARASI (EKİBE GÖRE DURUM) -->
  <section class="card">
    <h3>2) Blok Seç (Ekip durumunu renkten gör)</h3>

    <div class="grid row1" id="row1"></div>
    <div class="grid row2" id="row2" style="margin-top:8px"></div>
    <div class="grid row3" id="row3" style="margin-top:8px"></div>

    <div class="muted" id="crewHint" style="margin-top:6px">İpucu: Ekip seç, sonra bloklara tıkla.</div>
  </section>

  <!-- 3) HIZLI KAYIT -->
  <section class="card">
    <h3>3) Hızlı Kayıt</h3>
    <div class="row">
      <select id="who" style="min-width:140px">
        <option value="">İsim seç</option>
        <option>Muhammet</option><option>Harun</option><option>Metin</option>
        <option>Mert</option><option>Fuat</option><option>Furkan</option>
        <option>Misafir</option>
      </select>

      <input id="block" placeholder="Blok" style="min-width:120px" readonly />
      <input id="crew"  placeholder="Ekip" style="min-width:160px" readonly />

      <select id="state" style="min-width:150px">
        <option value="başladı">Başladı</option>
        <option value="devam ediyor">Devam ediyor</option>
        <option value="tamamlandı">Tamamlandı</option>
      </select>
    </div>

    <div class="row" style="margin-top:8px">
      <textarea id="text" placeholder="Not (opsiyonel)"></textarea>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="save">Kaydet</button>
      <button id="cancelEdit" class="ghost" style="display:none">İptal</button>
      <span id="msg" class="muted"></span>
    </div>
  </section>

  <!-- 4) SON KAYITLAR -->
  <section class="card">
    <h3>Son Kayıtlar</h3>
    <div id="list" class="list muted">Kayıt yok.</div>
  </section>

</div>

<script>
  /* ==== Sabit blok dizilimi (3 sıra) ==== */
  const ROW1 = ["AC","AD","AE","AF","AG","AH","AI","AJ","AK","AL","AM","AN"]; // 12
  const ROW2 = ["AB","Y","V","S","R","P","O","N","M","L","K","J","I"];         // 13
  const ROW3 = ["AA","Z","U","T","A","B","C","D","E","F","G","H"];            // 12
  const ALL_BLOCKS = [...ROW1, ...ROW2, ...ROW3];

  // Ekip listesi (geçerlilik için)
  const CREWS = ["Elektrik","Mekanik","Çatı (kereste)","Çatı (kiremit)","Çatı (oluk)","Denizlik","Parke","Seramik","Boya","Tg5","PVC","Kör Kasa","Şap","Dış Cephe","Makina Alçı","Saten Alçı","Kaba Sıva (iç)"];
  const STATES = ["başladı","devam ediyor","tamamlandı"];

  // Daire tipi arka planları
  const T41 = new Set(["AA","Z","U","T"]);
  const T51 = new Set(["A","B","C","D","E","F","G","H"]);
  const T62 = new Set(["AI","AJ","AK","AL","AM","AN","P","O","N","M","L","K","J","I"]);
  const T72 = new Set(["AC","AD","AE","AF","AG","AH","AB","Y","V","S","R"]);

  // Sahiplik + Patron
  const OWNER = new Set(["AC","AD","AH","AI","AJ","Y","R","P","O","N","J","I","Z","A","B","C","H"]);
  const PATRON = "R";

  const el = id => document.getElementById(id);

  /* ==== LocalStorage ==== */
  const KEY = 'santiye_notes_v2'; // v2: id destekli
  const load = () => { try { return JSON.parse(localStorage.getItem(KEY))||[] } catch { return [] } };
  const save = (arr) => localStorage.setItem(KEY, JSON.stringify(arr));
  const newId = ()=> 'n_'+Math.random().toString(36).slice(2,10)+Date.now().toString(36);

  // Bir ekip için her bloktaki SON durumu hesapla
  function latestStatusByBlockForCrew(crew){
    const notes = load();
    const map = new Map(); // block -> {state, ts}
    notes.forEach(n=>{
      if(n.crew!==crew) return;
      const prev = map.get(n.block);
      if(!prev || (n.ts>prev.ts)) map.set(n.block, {state:n.state, ts:n.ts});
    });
    const stateClass = (s)=>{
      if(!s) return 'st-none';
      if(s==='tamamlandı') return 'st-done';
      if(s==='devam ediyor' || s==='başladı') return 'st-progress';
      return 'st-progress';
    };
    const out = {};
    ALL_BLOCKS.forEach(b=>{ out[b] = stateClass(map.get(b)?.state); });
    return out;
  }

  /* ==== Blok ızgarası ==== */
  const buckets = [
    {row: ROW1, el: el('row1')},
    {row: ROW2, el: el('row2')},
    {row: ROW3, el: el('row3')}
  ];
  const typeClass = (code)=> T41.has(code) ? 't-41' : T51.has(code) ? 't-51' : T62.has(code) ? 't-62' : T72.has(code) ? 't-72' : '';

  function paintGrid(){
    const crewSel = el('crewPick').value;
    const filt = el('statusFilter').value; // '', 'done', 'progress', 'none'
    const st = crewSel ? latestStatusByBlockForCrew(crewSel) : {};

    buckets.forEach(({row,el:wrap})=>{
      wrap.innerHTML='';
      row.forEach(code=>{
        const btn = document.createElement('button');
        btn.type='button';
        let cls = `tile ${typeClass(code)}`;
        if (OWNER.has(code)) cls+=' own';
        if (code===PATRON) cls+=' patron';

        const sClass = st[code] || 'st-none';
        cls += ` ${sClass}`;
        btn.className = cls;

        // filtre
        let keep = true;
        if (filt==='done'     && sClass!=='st-done') keep=false;
        if (filt==='progress' && sClass!=='st-progress') keep=false;
        if (filt==='none'     && sClass!=='st-none') keep=false;
        if (!keep) btn.style.display='none';

        const ownerLbl = code===PATRON ? 'patronun villası 😄' : (OWNER.has(code)?'arsa sahibi':'müteahhit');
        let stateLbl = 'başlanmadı';
        if (sClass==='st-done') stateLbl='tamamlandı';
        else if (sClass==='st-progress') stateLbl='devam/başladı';
        btn.innerHTML = `${code}<span class="badge">${ownerLbl} • ${el('crewPick').value?stateLbl:''}</span>`;

        btn.onclick = ()=>{
          const cPick = el('crewPick').value;
          if(!cPick){ alert('Önce ekip seç'); return; }
          el('block').value = code;
          el('crew').value  = cPick;
          document.querySelectorAll('.card')[2].scrollIntoView({behavior:'smooth'});
        };
        wrap.appendChild(btn);
      });
    });

    el('crewHint').textContent = el('crewPick').value ? 'Bir bloğa tıkla: form otomatik dolacak.' : 'İpucu: Ekip seç, sonra bloklara tıkla.';
  }

  /* ==== İsim hatırlama ==== */
  const whoSel = el('who');
  const savedWho = localStorage.getItem('santiye_who');
  if (savedWho) whoSel.value = savedWho;
  whoSel.addEventListener('change', ()=> localStorage.setItem('santiye_who', whoSel.value));

  /* ==== Kayıt & Liste ==== */
  let editId = null; // düzenleme modunda hangi kayıt

  function say(m){ const msg=el('msg'); msg.textContent=m; setTimeout(()=>msg.textContent='',2200) }

  function validateInputs({who, block, crew, state}){
    if(!who) return "İsim seç";
    if(!crew) return "Ekip seç (üstten ekip seçip blok tıkla)";
    if(!block) return "Blok seç (ızgaradan tıkla)";
    if(!ALL_BLOCKS.includes(block)) return "Geçersiz blok kodu";
    if(!CREWS.includes(crew)) return "Geçersiz ekip";
    if(!STATES.includes(state)) return "Geçersiz durum";
    return "";
  }

  function renderList(){
    const listEl = el('list');
    const items = load().sort((a,b)=>b.ts-a.ts);
    if(!items.length){ listEl.classList.add('muted'); listEl.textContent='Kayıt yok.'; return; }
    listEl.classList.remove('muted'); listEl.innerHTML='';
    items.forEach(n=>{
      const when = new Date(n.ts).toLocaleString();
      const div = document.createElement('div');
      div.className='note';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <div><b>${n.block}</b> <span class="chip">${n.crew}</span> <span class="chip">${n.state}</span> <span class="chip">${n.user}</span></div>
          <span class="muted">${when}</span>
        </div>
        <div style="margin-top:6px">${n.text? n.text.replace(/</g,"&lt;") : ''}</div>
        <div class="row" style="margin-top:8px">
          <button class="ghost" data-edit="${n.id}">Düzelt</button>
          <button class="danger" data-del="${n.id}">Sil</button>
        </div>`;
      listEl.appendChild(div);
    });

    // olaylar
    listEl.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute('data-edit');
        const rec = load().find(x=>x.id===id);
        if(!rec) return;
        editId = id;
        whoSel.value = rec.user;
        el('block').value = rec.block;
        el('crew').value  = rec.crew;
        el('state').value = rec.state;
        el('text').value  = rec.text || '';
        el('save').textContent = 'Güncelle';
        el('cancelEdit').style.display = 'inline-block';
        say('Düzenleme modundasın');
      };
    });
    listEl.querySelectorAll('[data-del]').forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute('data-del');
        if(!confirm('Bu kaydı silmek istiyor musun?')) return;
        const arr = load().filter(x=>x.id!==id);
        save(arr);
        renderList();
        paintGrid();
        say('Silindi');
        if(editId===id){ // silinen kayıt düzenlemede ise formu temizle
          editId=null;
          el('save').textContent='Kaydet';
          el('cancelEdit').style.display='none';
          el('text').value='';
        }
      };
    });
  }

  function resetFormKeepCrewWho(){
    el('text').value='';
    el('state').value='başladı';
    // who ve crew/block'ı koru
  }

  el('cancelEdit').onclick = ()=>{
    editId=null;
    el('save').textContent='Kaydet';
    el('cancelEdit').style.display='none';
    resetFormKeepCrewWho();
    say('Düzenleme iptal edildi');
  };

  el('save').onclick = ()=>{
    const who   = (whoSel.value||'').trim();
    const block = (el('block').value||'').trim().toUpperCase();
    const crew  = (el('crew').value||'').trim();
    const state = el('state').value;
    const text  = (el('text').value||'').trim();

    const err = validateInputs({who,block,crew,state});
    if (err) { say(err); return; }

    const arr = load();
    if(editId){
      const i = arr.findIndex(x=>x.id===editId);
      if(i>-1){
        arr[i] = { ...arr[i], user:who, block, crew, state, text, ts: Date.now() };
        save(arr);
        say('Güncellendi ✅');
      }
      editId=null;
      el('save').textContent='Kaydet';
      el('cancelEdit').style.display='none';
    }else{
      arr.push({ id:newId(), user: who, block, crew, state, text, ts: Date.now() });
      save(arr);
      say('Kaydedildi ✅');
    }
    renderList();
    paintGrid();
    resetFormKeepCrewWho();
  };

  // Ekip seçimi & filtre
  el('crewPick').addEventListener('change', ()=>{
    el('crew').value = el('crewPick').value || '';
    paintGrid();
  });
  el('statusFilter').addEventListener('change', paintGrid);
  el('clearFilter').addEventListener('click', ()=>{ el('statusFilter').value=''; paintGrid(); });

  // İlk çizimler
  paintGrid();
  renderList();
</script>
</body>
</html>

<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Åantiye Takip â€“ CanlÄ± (Firestore + Push)</title>
<style>
  :root{--bg:#0b1220;--card:#111827;--line:#1f2937;--muted:#94a3b8}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:var(--bg);color:#e5e7eb}
  header{position:sticky;top:0;background:#0b1220cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:10px 14px;font-weight:800;display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
  .wrap{max-width:1000px;margin:12px auto;padding:0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-top:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:10px 12px;border-radius:10px;border:1px solid #243244;background:#0b1220;color:#e5e7eb}
  textarea{min-height:80px;width:100%}
  button{background:linear-gradient(90deg,#0ea5e9,#22d3ee);color:#001016;border:none;font-weight:700;cursor:pointer}
  .ghost{background:#0b1220;border:1px solid #243244;color:#e5e7eb}
  .danger{background:#7f1d1d;color:#fff;border:none}
  .muted{color:var(--muted)}
  .list{display:flex;flex-direction:column;gap:8px}
  .note{border-left:3px solid #0ea5e9;padding-left:10px}
  .grid{display:grid;gap:8px}
  .row1{grid-template-columns:repeat(12,1fr)}
  .row2{grid-template-columns:repeat(13,1fr)}
  .row3{grid-template-columns:repeat(12,1fr)}
  .tile{padding:10px 6px;text-align:center;border:1px solid #243244;border-radius:10px;background:#0b1220;cursor:pointer;font-weight:800}
  .badge{font-size:10px;color:#cbd5e1;display:block;margin-top:4px;font-weight:500}
  .t-41{background:#7c2d4e}.t-51{background:#8a6a15}.t-62{background:#0f3b46}.t-72{background:#153056}
  .own{border-color:#22d3ee}.patron{outline:2px dashed #22d3ee}
  .st-none{box-shadow:0 0 0 3px #374151 inset}.st-progress{box-shadow:0 0 0 3px #f59e0b inset}.st-done{box-shadow:0 0 0 3px #10b981 inset}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;vertical-align:middle;margin-right:6px}
  .chip{padding:2px 6px;border-radius:999px;border:1px solid #334155;background:#0b1220;color:#cbd5e1;font-size:12px}
</style>
</head>
<body>
<header>
  <div>ğŸ—ï¸ Åantiye Takip â€“ CanlÄ± (Firestore + Push)</div>
  <div class="row">
    <button id="btnNotify">ğŸ”” Bildirimleri AÃ§</button>
    <span id="permStatus" class="muted"></span>
  </div>
</header>

<div class="wrap">
  <!-- 1) EKÄ°P SEÃ‡ + FÄ°LTRE -->
  <section class="card">
    <h3>1) Ekip SeÃ§</h3>
    <div class="row">
      <select id="crewPick" style="min-width:200px">
        <option value="">Ekip seÃ§</option>
        <option>Elektrik</option><option>Mekanik</option>
        <option>Ã‡atÄ± (kereste)</option><option>Ã‡atÄ± (kiremit)</option><option>Ã‡atÄ± (oluk)</option>
        <option>Denizlik</option><option>Parke</option><option>Seramik</option><option>Boya</option>
        <option>Tg5</option><option>PVC</option><option>KÃ¶r Kasa</option><option>Åap</option>
        <option>DÄ±ÅŸ Cephe</option><option>Makina AlÃ§Ä±</option><option>Saten AlÃ§Ä±</option><option>Kaba SÄ±va (iÃ§)</option>
      </select>
      <span class="muted">Durum:
        <span class="dot" style="background:#10b981"></span>tamamlandÄ± â€¢
        <span class="dot" style="background:#f59e0b"></span>devam ediyor â€¢
        <span class="dot" style="background:#374151"></span>baÅŸlanmadÄ±
      </span>
      <select id="statusFilter">
        <option value="">TÃ¼mÃ¼</option>
        <option value="done">Sadece tamamlanan</option>
        <option value="progress">Sadece devam eden</option>
        <option value="none">Sadece baÅŸlanmayan</option>
      </select>
      <button id="clearFilter" class="ghost">Filtreyi sÄ±fÄ±rla</button>
    </div>
  </section>

  <!-- 2) BLOK IZGARASI -->
  <section class="card">
    <h3>2) Blok SeÃ§ (Ekip durumunu renkten gÃ¶r)</h3>
    <div class="grid row1" id="row1"></div>
    <div class="grid row2" id="row2" style="margin-top:8px"></div>
    <div class="grid row3" id="row3" style="margin-top:8px"></div>
    <div class="muted" id="crewHint" style="margin-top:6px">Ä°pucu: Ekip seÃ§, sonra bloklara tÄ±kla.</div>
  </section>

  <!-- 3) HIZLI KAYIT -->
  <section class="card">
    <h3>3) HÄ±zlÄ± KayÄ±t</h3>
    <div class="row">
      <select id="who" style="min-width:140px">
        <option value="">Ä°sim seÃ§</option>
        <option>Muhammet</option><option>Harun</option><option>Metin</option>
        <option>Mert</option><option>Fuat</option><option>Furkan</option>
        <option>Misafir</option>
      </select>
      <input id="block" placeholder="Blok" style="min-width:120px" readonly />
      <input id="crew"  placeholder="Ekip" style="min-width:160px" readonly />
      <select id="state" style="min-width:150px">
        <option value="baÅŸladÄ±">BaÅŸladÄ±</option>
        <option value="devam ediyor">Devam ediyor</option>
        <option value="tamamlandÄ±">TamamlandÄ±</option>
      </select>
    </div>
    <div class="row" style="margin-top:8px">
      <textarea id="text" placeholder="Not (opsiyonel)"></textarea>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="save">Kaydet</button>
      <button id="cancelEdit" class="ghost" style="display:none">Ä°ptal</button>
      <span id="msg" class="muted"></span>
    </div>
  </section>

  <!-- 4) SON KAYITLAR -->
  <section class="card">
    <h3>Son KayÄ±tlar</h3>
    <div id="list" class="list muted">KayÄ±t yok.</div>
  </section>
</div>

<script type="module">
  /* ==== Firebase ==== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
    serverTimestamp, query, orderBy, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  import {
    getMessaging, getToken, onMessage, isSupported
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAdvmca8C-RXTrnvhH4dEX1bFhYrMlyhSE",
    authDomain: "santiye-takip-83874.firebaseapp.com",
    projectId: "santiye-takip-83874",
    storageBucket: "santiye-takip-83874.firebasestorage.app",
    messagingSenderId: "893666575482",
    appId: "1:893666575482:web:762be4fb7feea74a7aa7c3"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  /* ==== UI yardÄ±mcÄ± ==== */
  const el = id => document.getElementById(id);
  const ROW1 = ["AC","AD","AE","AF","AG","AH","AI","AJ","AK","AL","AM","AN"];
  const ROW2 = ["AB","Y","V","S","R","P","O","N","M","L","K","J","I"];
  const ROW3 = ["AA","Z","U","T","A","B","C","D","E","F","G","H"];
  const ALL_BLOCKS = [...ROW1, ...ROW2, ...ROW3];
  const CREWS = ["Elektrik","Mekanik","Ã‡atÄ± (kereste)","Ã‡atÄ± (kiremit)","Ã‡atÄ± (oluk)","Denizlik","Parke","Seramik","Boya","Tg5","PVC","KÃ¶r Kasa","Åap","DÄ±ÅŸ Cephe","Makina AlÃ§Ä±","Saten AlÃ§Ä±","Kaba SÄ±va (iÃ§)"];
  const STATES = ["baÅŸladÄ±","devam ediyor","tamamlandÄ±"];
  const T41 = new Set(["AA","Z","U","T"]);
  const T51 = new Set(["A","B","C","D","E","F","G","H"]);
  const T62 = new Set(["AI","AJ","AK","AL","AM","AN","P","O","N","M","L","K","J","I"]);
  const T72 = new Set(["AC","AD","AE","AF","AG","AH","AB","Y","V","S","R"]);
  const OWNER  = new Set(["AC","AD","AH","AI","AJ","Y","R","P","O","N","J","I","Z","A","B","C","H"]);
  const PATRON = "R";
  const typeClass = (code)=> T41.has(code) ? 't-41' : T51.has(code) ? 't-51' : T62.has(code) ? 't-62' : T72.has(code) ? 't-72' : '';

  let notes = [];
  const qNotes = query(collection(db,'notes'), orderBy('ts','desc'));
  onSnapshot(qNotes, (snap)=>{
    notes = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    renderList();
    paintGrid();
  });

  function tsToString(ts){
    try{ return ts?.toDate ? ts.toDate().toLocaleString() : new Date(ts||0).toLocaleString(); }catch{ return '' }
  }
  function latestStatusByBlockForCrew(crew){
    const map = new Map();
    notes.forEach(n=>{
      if(n.crew!==crew) return;
      const t = n.ts?.toMillis ? n.ts.toMillis() : (typeof n.ts==='number'?n.ts:0);
      const prev = map.get(n.block);
      if(!prev || t>prev.ts) map.set(n.block,{state:n.state,ts:t});
    });
    const cls = s => !s ? 'st-none' : (s==='tamamlandÄ±' ? 'st-done' : 'st-progress');
    const out = {}; ALL_BLOCKS.forEach(b=> out[b]=cls(map.get(b)?.state));
    return out;
  }

  const buckets = [
    {row: ROW1, el: el('row1')},
    {row: ROW2, el: el('row2')},
    {row: ROW3, el: el('row3')}
  ];

  function paintGrid(){
    const crewSel = el('crewPick').value;
    const filt = el('statusFilter').value;
    const st = crewSel ? latestStatusByBlockForCrew(crewSel) : {};
    buckets.forEach(({row,el:wrap})=>{
      wrap.innerHTML='';
      row.forEach(code=>{
        const btn = document.createElement('button');
        btn.type='button';
        let cls=`tile ${typeClass(code)}`;
        if (OWNER.has(code)) cls+=' own';
        if (code===PATRON) cls+=' patron';
        const sClass = st[code] || 'st-none';
        cls += ` ${sClass}`;
        btn.className=cls;
        let keep = true;
        if (filt==='done' && sClass!=='st-done') keep=false;
        if (filt==='progress' && sClass!=='st-progress') keep=false;
        if (filt==='none' && sClass!=='st-none') keep=false;
        if (!keep) btn.style.display='none';
        const ownerLbl = code===PATRON ? 'patronun villasÄ± ğŸ˜„' : (OWNER.has(code)?'arsa sahibi':'mÃ¼teahhit');
        let stateLbl = 'baÅŸlanmadÄ±';
        if (sClass==='st-done') stateLbl='tamamlandÄ±'; else if (sClass==='st-progress') stateLbl='devam/baÅŸladÄ±';
        btn.innerHTML = `${code}<span class="badge">${ownerLbl} â€¢ ${el('crewPick').value?stateLbl:''}</span>`;
        btn.onclick = ()=>{
          const cPick = el('crewPick').value;
          if(!cPick){ alert('Ã–nce ekip seÃ§'); return; }
          el('block').value = code;
          el('crew').value  = cPick;
          document.querySelectorAll('.card')[2].scrollIntoView({behavior:'smooth'});
        };
        wrap.appendChild(btn);
      });
    });
    el('crewHint').textContent = el('crewPick').value ? 'Bir bloÄŸa tÄ±kla: form otomatik dolacak.' : 'Ä°pucu: Ekip seÃ§, sonra bloklara tÄ±kla.';
  }

  const whoSel = el('who');
  const savedWho = localStorage.getItem('santiye_who');
  if (savedWho) whoSel.value = savedWho;
  whoSel.addEventListener('change', ()=> localStorage.setItem('santiye_who', whoSel.value));

  let editId=null;
  function say(m){ const msg=el('msg'); msg.textContent=m; setTimeout(()=>msg.textContent='',2200) }
  function validateInputs({who, block, crew, state}){
    if(!who) return "Ä°sim seÃ§";
    if(!crew) return "Ekip seÃ§ (Ã¼stten ekip seÃ§ip blok tÄ±kla)";
    if(!block) return "Blok seÃ§ (Ä±zgaradan tÄ±kla)";
    if(!ALL_BLOCKS.includes(block)) return "GeÃ§ersiz blok kodu";
    if(!CREWS.includes(crew)) return "GeÃ§ersiz ekip";
    if(!STATES.includes(state)) return "GeÃ§ersiz durum";
    return "";
  }
  function resetFormKeepCrewWho(){ el('text').value=''; el('state').value='baÅŸladÄ±'; }

  el('cancelEdit').onclick = ()=>{
    editId=null; el('save').textContent='Kaydet'; el('cancelEdit').style.display='none';
    resetFormKeepCrewWho(); say('DÃ¼zenleme iptal edildi');
  };

  el('save').onclick = async ()=>{
    const who   = (whoSel.value||'').trim();
    const block = (el('block').value||'').trim().toUpperCase();
    const crew  = (el('crew').value||'').trim();
    const state = el('state').value;
    const text  = (el('text').value||'').trim();
    const err = validateInputs({who,block,crew,state});
    if (err) { say(err); return; }
    try{
      if(editId){
        await updateDoc(doc(db,'notes',editId), { user:who, block, crew, state, text, ts: serverTimestamp() });
        editId=null; el('save').textContent='Kaydet'; el('cancelEdit').style.display='none'; say('GÃ¼ncellendi âœ…');
      }else{
        await addDoc(collection(db,'notes'), { user:who, block, crew, state, text, ts: serverTimestamp() });
        say('Kaydedildi âœ…');
      }
      resetFormKeepCrewWho();
    }catch(e){ console.error(e); say('Hata: ' + (e.code||e.message||'kayÄ±t yazÄ±lamadÄ±')); }
  };

  function renderList(){
    const listEl = el('list');
    if(!notes.length){ listEl.classList.add('muted'); listEl.textContent='KayÄ±t yok.'; return; }
    listEl.classList.remove('muted'); listEl.innerHTML='';
    notes.forEach(n=>{
      const when = tsToString(n.ts);
      const div = document.createElement('div');
      div.className='note';
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
          <div><b>${n.block}</b> <span class="chip">${n.crew}</span> <span class="chip">${n.state}</span> <span class="chip">${n.user}</span></div>
          <span class="muted">${when}</span>
        </div>
        <div style="margin-top:6px">${n.text? String(n.text).replace(/</g,"&lt;") : ''}</div>
        <div class="row" style="margin-top:8px">
          <button class="ghost" data-edit="${n.id}">DÃ¼zelt</button>
          <button class="danger" data-del="${n.id}">Sil</button>
        </div>`;
      listEl.appendChild(div);
    });
    listEl.querySelectorAll('[data-edit]').forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute('data-edit');
        const rec = notes.find(x=>x.id===id); if(!rec) return;
        editId=id;
        whoSel.value = rec.user||''; el('block').value = rec.block||''; el('crew').value  = rec.crew||'';
        el('state').value = rec.state||'baÅŸladÄ±'; el('text').value  = rec.text||'';
        el('save').textContent='GÃ¼ncelle'; el('cancelEdit').style.display='inline-block'; say('DÃ¼zenleme modundasÄ±n');
      };
    });
    listEl.querySelectorAll('[data-del]').forEach(b=>{
      b.onclick = async ()=>{
        const id = b.getAttribute('data-del');
        if(!confirm('Bu kaydÄ± silmek istiyor musun?')) return;
        await deleteDoc(doc(db,'notes',id)); say('Silindi');
      };
    });
  }

  // === Bildirim (Web Push) ===
  const permStatus = el('permStatus');
  const btnNotify  = el('btnNotify');
  const VAPID_PUBLIC_KEY = "BJOemRk6vKqnI0Y_61OP9-AUbrt-RAepLnANXlz5JZ4jKRKOY_0AO9M0zG_fNO74DdJA2Kr4X0BQ07BNmih3vUY";

  function setPermText(){
    permStatus.textContent = (Notification.permission === 'granted')
      ? 'Bildirim: AÃ‡IK'
      : (Notification.permission === 'denied' ? 'Bildirim: ENGELLÄ°' : 'Bildirim: Ä°ZÄ°N Ä°STENMEDÄ°');
  }
  setPermText();

  // SW kaydÄ± (GitHub Pages altÄ±nda kÃ¶kte olmalÄ±)
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/Santiye-takip/firebase-messaging-sw.js');
  }

  let fcmToken = null;

  btnNotify.onclick = async ()=>{
    try{
      if (!(await isSupported())) { alert('TarayÄ±cÄ± push desteklemiyor'); return; }
      const granted = await Notification.requestPermission();
      setPermText();
      if (granted !== 'granted') return;

      const messaging = getMessaging(app);
      fcmToken = await getToken(messaging, {
        vapidKey: VAPID_PUBLIC_KEY,
        serviceWorkerRegistration: await navigator.serviceWorker.getRegistration('/Santiye-takip/firebase-messaging-sw.js')
      });

      if (!fcmToken) { alert('Token alÄ±namadÄ±'); return; }

      // Token'Ä± Firestore'a yaz (tekillik)
      await addDoc(collection(db,'fcm_tokens'), {
        token: fcmToken,
        user: (localStorage.getItem('santiye_who')||'Bilinmiyor'),
        ua: navigator.userAgent,
        createdAt: serverTimestamp()
      });

      btnNotify.textContent = 'ğŸ”” Bildirimler AÃ§Ä±k';
      say('Bildirim izni verildi âœ…');

      // Ã–n planda yeni mesaj geldiÄŸinde kÃ¼Ã§Ã¼k bip gÃ¶ster
      onMessage(messaging, (payload)=>{
        try {
          // kÃ¼Ã§Ã¼k bip: izin gerektirmiyor
          const ctx = new (window.AudioContext||window.webkitAudioContext)();
          const o = ctx.createOscillator(); const g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination); o.frequency.value=1200; g.gain.value=0.05;
          o.start(); setTimeout(()=>{o.stop();ctx.close()},140);
        } catch {}
      });

    }catch(e){
      console.error(e);
      alert('Bildirim kurulamadÄ±: ' + (e.code||e.message));
    }
  };

  // Filtre ve ekip seÃ§im
  el('crewPick').addEventListener('change', ()=>{ el('crew').value = el('crewPick').value || ''; paintGrid(); });
  el('statusFilter').addEventListener('change', paintGrid);
  el('clearFilter').addEventListener('click', ()=>{ el('statusFilter').value=''; paintGrid(); });

  // Ä°lk Ã§izimler
  paintGrid();
</script>
</body>
</html>

<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>≈ûantiye Takip</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root {
      --bg: #0b1220;
      --card: #111827;
      --muted: #94a3b8;
      --pri: #0ea5e9;
      --line: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial;
      background: var(--bg);
      color: #e5e7eb;
    }
    header {
      position: sticky;
      top: 0;
      background: #0b1220cc;
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--line);
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo { font-weight: 700; letter-spacing: .3px; }
    .wrap { max-width: 980px; margin: 12px auto; padding: 0 12px; }
    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      margin-top: 12px;
    }
    input, button, select, textarea {
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #243244;
      background: #0b1220;
      color: #e5e7eb;
    }
    button {
      background: linear-gradient(90deg, #0ea5e9, #22d3ee);
      color: #001016;
      border: none;
      font-weight: 700;
      cursor: pointer;
    }
    .ghost { background: #0b1220; border: 1px solid #243244; color: #e5e7eb; }
    .tabs { display: flex; gap: 8px; margin-top: 8px; }
    .tabs button { background: #0b1220; border: 1px solid var(--line); }
    .tabs button.active {
      background: linear-gradient(90deg, #0ea5e9, #22d3ee);
      color: #001016;
      border: none;
    }
    .tab { display: none; margin-top: 12px; }
    .tab.active { display: block; }
  </style>
</head>
<body>
  <header>
    <div class="logo">üèóÔ∏è ≈ûantiye Takip</div>
    <div id="loginUser"></div>
  </header>

  <div class="wrap">
    <!-- LOGIN EKRANI -->
    <section id="loginCard" class="card">
      <h3>Giri≈ü</h3>
      <p class="muted">Kullanƒ±cƒ±lar: Muhammet, Harun, Metin, Mert, Fuat, Furkan, Misafir ‚Äî ≈ûifre: 1234</p>
      <input id="inpUser" placeholder="Kullanƒ±cƒ± adƒ±" />
      <input id="inpPass" type="password" placeholder="≈ûifre" />
      <button id="btnLogin">Giri≈ü Yap</button>
      <p id="loginErr" style="color:#f87171"></p>
    </section>

    <!-- ANA SEKME -->
    <section id="app" class="card" style="display:none;">
      <div class="tabs">
        <button data-tab="tabBlocks" class="active">Bloklar</button>
        <button data-tab="tabNotes">Notlar</button>
        <button data-tab="tabCrews">Ekipler</button>
      </div>

      <div id="tabBlocks" class="tab active">
        <h3>Bloklar</h3>
        <div id="blocksGrid" class="grid"></div>
      </div>

      <div id="tabNotes" class="tab">
        <h3>Notlar</h3>
        <textarea id="noteText" placeholder="Not ekle..."></textarea>
        <button id="btnAddNote">Kaydet</button>
        <div id="notesList"></div>
      </div>

      <div id="tabCrews" class="tab">
        <h3>Ekipler</h3>
        <select id="crewType"></select>
        <input id="crewCount" type="number" placeholder="Ki≈üi sayƒ±sƒ±" />
        <button id="btnCrewSave">Kaydet</button>
        <div id="crewList"></div>
      </div>
    </section>
  </div>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

  const el = id => document.getElementById(id);
  const loginCard = el("loginCard");
  const appCard = el("app");
  const loginUser = el("loginUser");
  const loginErr = el("loginErr");
  const blocksGrid = el("blocksGrid");
  const noteText = el("noteText");
  const notesList = el("notesList");
  const crewType = el("crewType");
  const crewList = el("crewList");

  // üîπ Yardƒ±mcƒ± fonksiyonlar
  const showToast = msg => alert(msg);
  const saveSession = u => localStorage.setItem("santiye_user", JSON.stringify(u));
  const getSession = () => JSON.parse(localStorage.getItem("santiye_user") || "null");
  const clearSession = () => localStorage.removeItem("santiye_user");

  // üîπ Kullanƒ±cƒ±lar
  const users = [
    { username: "Muhammet", password: "1234" },
    { username: "Harun", password: "1234" },
    { username: "Metin", password: "1234" },
    { username: "Mert", password: "1234" },
    { username: "Fuat", password: "1234" },
    { username: "Furkan", password: "1234" },
    { username: "Misafir", password: "1234" }
  ];

  // üîπ Firebase config y√ºkle
  const fbconf = await fetch("src/data/firebase.json").then(r => r.json());
  const fcmconf = await fetch("src/data/fcm.json").then(r => r.json());
  const app = initializeApp(fbconf);
  const db = getFirestore(app);

  // üîπ Giri≈ü i≈ülemi
  const session = getSession();
  if (session) showApp(session);

  el("btnLogin").onclick = () => {
    const u = el("inpUser").value.trim();
    const p = el("inpPass").value.trim();
    const found = users.find(x => x.username.toLowerCase() === u.toLowerCase() && x.password === p);
    if (!found) {
      loginErr.textContent = "Hatalƒ± kullanƒ±cƒ± adƒ± veya ≈üifre.";
      return;
    }
    saveSession(found);
    showApp(found);
  };

  function showApp(user) {
    loginCard.style.display = "none";
    appCard.style.display = "block";
    loginUser.textContent = "üë∑ " + user.username;
    initApp(user);
  }

  // üîπ Firestore canlƒ± not akƒ±≈üƒ±
  const q = query(collection(db, "notes"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    notesList.innerHTML = "";
    snapshot.forEach((doc) => {
      const n = doc.data();
      const elDiv = document.createElement("div");
      elDiv.className = "card";
      elDiv.innerHTML = `<b>${n.block || "Genel"}</b> - ${n.user}<br>${n.text}`;
      notesList.appendChild(elDiv);
    });
  });

  // üîπ Not ekleme
  el("btnAddNote").onclick = async () => {
    const u = getSession();
    if (!u) return alert("Giri≈ü yapmalƒ±sƒ±n!");
    const text = noteText.value.trim();
    if (!text) return alert("Not bo≈ü olamaz");
    await addDoc(collection(db, "notes"), {
      text,
      user: u.username,
      block: "Genel",
      createdAt: serverTimestamp()
    });
    noteText.value = "";
    showToast("Not eklendi ‚úÖ");
  };

  // üîπ Bildirim kurulumu (FCM)
  async function setupMessaging() {
    const supported = await isSupported();
    if (!supported) return console.log("FCM desteklenmiyor");

    const messaging = getMessaging(app);
    try {
      const token = await getToken(messaging, { vapidKey: fcmconf.vapidKey });
      console.log("FCM Token:", token);
      if (Notification.permission !== "granted") {
        await Notification.requestPermission();
      }
      onMessage(messaging, (payload) => {
        console.log("Yeni mesaj:", payload);
        new Notification("Yeni Bildirim", {
          body: payload.notification?.body || "Yeni not eklendi",
        });
      });
    } catch (err) {
      console.error("Bildirim hatasƒ±:", err);
    }
  }

  setupMessaging();

  // üîπ Ekipler √∂rnek liste
  const crews = ["Mekanik", "Elektrik", "√áatƒ± (kereste)", "√áatƒ± (kiremit)", "√áatƒ± (oluk)", "Denizlik", "Parke", "Seramik", "Boya", "TG5", "PVC", "K√∂r Kasa", "≈ûap", "Dƒ±≈ü Cephe", "Makina Al√ßƒ±", "Saten Al√ßƒ±", "Kaba Sƒ±va (i√ß)"];
  crewType.innerHTML = crews.map(c => `<option>${c}</option>`).join("");

  el("btnCrewSave").onclick = () => {
    const type = crewType.value;
    const count = el("crewCount").value;
    if (!count) return alert("Ki≈üi sayƒ±sƒ± gir");
    const t = document.createElement("div");
    t.className = "card";
    t.textContent = `${type}: ${count} ki≈üi`;
    crewList.prepend(t);
  };
</script>
  <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').catch(console.error);
  navigator.serviceWorker.register('/firebase-messaging-sw.js').catch(console.error);
}
  </script>
</body>
</html>
